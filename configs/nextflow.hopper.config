// Hopper specific configuration for micro wgs pipeline //

singularity{
	enabled = true
	runOptions = '--bind /fs1/ --bind /fs2/ --bind /local/ --bind /mnt/beegfs/'
}

params {
	root = "/fs1/pipelines/JASEN"
	// DATABASES //
	resfinderDb = "${root}/assets/resfinder_db"
	pointfinderDb = "${root}/assets/pointfinder_db"
	virulencefinderDb = "${root}/assets/virulencefinder_db"
	mlstBlastDb = "${root}/assets/mlst_db/blast"
	krakenDb = "/fs1/resources/ref/micro/krakenstd"
	// INPUT & OUTPUT //
	workDir = "/fs1/ryan/pipelines/jasen/wd"
	publishDir = ""
	publishDirMode = 'copy'
	publishDirOverwrite = true
	scratch = true
	containerDir = "${root}/container" //change
	outdir = "/fs1/results_dev/jasen/test"
	args = ""
	prefix = ""
	// PIPELINE OPTIONS //
	useKraken = true
	useSkesa = true // To use spades set useSkesa = false
}

process {
	executor='slurm'
	queue='grace-high'
	time=2.h
	memory='1 GB'
	cpus=2

	withName: ariba_run {
		memory = '32 GB'
		container = "${params.containerDir}/ariba.sif"
		params.publishDir = "${params.outdir}/ariba"
		ext.args = "--force"
	}
	withName: ariba_summary {
		container = "${params.containerDir}/ariba.sif"
		params.publishDir = "${params.outdir}/ariba"
		ext.args = "--col_filter n --row_filter n"
	}
	withName: ariba_summary_to_json {
		container = "${params.containerDir}/perl.sif"
		params.publishDir = "${params.outdir}/ariba"
	}
	withName: assembly_trim_clean {
		container = "${params.containerDir}/perl.sif"
		cpus = 4
		memory = '10 GB'
		params.publishDir = "${params.outdir}/clean"
		ext.args = "--min_quality 23 --bases_to_trim 400 --min_length 100 -p 1 --nosingletons"
	}
	withName: bracken {
		container = "${params.containerDir}/bracken.sif"
		params.publishDir = "${params.outdir}/kraken"
		ext.args = "-r 150"
	}
	withName: bwa_index {
		container = "${params.containerDir}/bwakit.sif"
		params.publishDir = "${params.outdir}/bwa"
		ext.args = "-M"
	}
	withName: bwa_mem_dedup {
		container = "${params.containerDir}/bwakit.sif"
		cpus = 16
		memory = '2 GB'
		ext.args = "-M"
	}
	withName: bwa_mem_ref {
		container = "${params.containerDir}/bwakit.sif"
		cpus = 16
		memory = '2 GB'
		publishDir = [ path: "${params.outdir}/bwa", mode: 'copy' ]
		ext.args = "-M"
	}
	withName: chewbbaca_allelecall {
		cpus = 4
		memory = '2 GB'
		container = "${params.containerDir}/chewbbaca.sif"
		params.publishDir = "${params.outdir}/chewbbaca"
	}
	withName: 'chewbbaca_split_results|chewbbaca_split_missing_loci|chewbbaca_create_batch_list' {
		params.publishDir = "${params.outdir}/chewbbaca"
	}
	withName: create_analysis_result {
		container = "${params.containerDir}/pythonScripts.sif"
		params.publishDir = "${params.outdir}/analysis_result"
	}
	withName: export_to_cdm {
		params.publishDir = "/fs1/results_dev/cron/qc"
	}
	withName: freebayes {
		container = "${params.containerDir}/freebayes.sif"
		params.publishDir = "${params.outdir}/freebayes"
		ext.args = "-C 2 -F 0.2 --pooled-continuous"
	}
	withName: kraken {
		memory = '48 GB'
		container = "${params.containerDir}/kraken2.sif"
		params.publishDir = "${params.outdir}/kraken"
		ext.args = "--gzip-compressed"
	}
	withName: mask_polymorph_assembly {
		params.publishDir = "${params.outdir}/misc"
	}
	withName: mlst {
		container = "${params.containerDir}/mlst.sif"
		params.publishDir = "${params.outdir}/mlst"
	}
	withName: post_align_qc {
		container = "${params.containerDir}/postAlignQc.sif"
		params.publishDir = "${params.outdir}/postalignqc"
	}
	withName: quast {
		container = "${params.containerDir}/quast.sif"
		params.publishDir = "${params.outdir}/quast"
	}
	withName: resfinder {
		container = "${params.containerDir}/resfinder.sif"
		params.publishDir = "${params.outdir}/resfinder"
	}
	withName: 'samtools_sort|samtools_index' {
		cpus = 16
		memory = '2 GB'
		container = "${params.containerDir}/samtools.sif"
		params.publishDir = "${params.outdir}/samtools"
	}
	withName: save_analysis_metadata {
		container = "${params.containerDir}/pythonScripts.sif"
		params.publishDir = "${params.outdir}/analysis_metadata"
	}
	withName: spades_illumina {
		container = "${params.containerDir}/spades.sif"
		cpus = 16
		memory = '15 GB'
		params.publishDir = "${params.outdir}/spades_illumina"
		ext.args = "--isolate"
		ext.when = { !params.useSkesa }
	}
	withName: spades_iontorrent {
		container = "${params.containerDir}/spades.sif"
		cpus = 16
		memory = '15 GB'
		params.publishDir = "${params.outdir}/spades_iontorrent"
		ext.args = "--iontorrent --careful --sc"
	}
	withName: skesa {
		container = "${params.containerDir}/skesa.sif"
		cpus = 4
		memory = '10 GB'
		params.publishDir = "${params.outdir}/skesa"
		ext.args = "--cores 4 --memory 48"
		ext.when = { params.useSkesa }
	}
	withName: virulencefinder {
		cpus = 2
		container = "${params.containerDir}/virulencefinder.sif"
		params.publishDir = "${params.outdir}/virulencefinder"
	}
}

profiles {
	staphylococcus_aureus {
		params.species = "staphylococcus aureus"
		params.genomeReference = "${params.root}/assets/genomes/staphylococcus_aureus/NC_002951.2.fasta"
		params.aribaReference = "${params.root}/assets/card/nucleotide_fasta_protein_homolog_model.fasta"
		params.cgmlstDb = "${params.root}/assets/cgmlst/staphylococcus_aureus/alleles_rereffed"
		params.cgmlstLociBed = "${params.root}/assets/cgmlst/staphylococcus_aureus/bed/NC_002951.2.bed"
		params.trainingFile = "${params.root}/assets/prodigal_training_files/Staphylococcus_aureus.trn"
		params.useVirulenceDbs = ['s.aureus_hostimm', 's.aureus_exoenzyme', 's.aureus_toxin']
	}

	escherichia_coli {
		params.species = 'escherichia coli'
		params.genomeReference = "${params.root}/assets/genomes/escherichia_coli/NC_000913.3.fasta"
		params.aribaReference = "${params.root}/assets/card/nucleotide_fasta_protein_homolog_model.fasta"
		params.cgmlstDb = "${params.root}/assets/cgmlst/escherichia_coli/alleles_rereffed"
		params.cgmlstLociBed = "${params.root}/assets/cgmlst/escherichia_coli/bed/NC_000913.3.bed"
		params.trainingFile = "${params.root}/assets/prodigal_training_files/Escherichia_coli.trn"
		params.useVirulenceDbs = ['virulence_ecoli']
	}

	klebsiella_pneumoniae {
		params.species = 'klebsiella pneumoniae'
		params.genomeReference = "${params.root}/assets/genomes/NC_016845.1.fasta"
		params.aribaReference = "${params.root}/assets/card/nucleotide_fasta_protein_homolog_model.fasta"
		params.cgmlstDb = "${params.root}/assets/cgmlst/klebsiella_pneumoniae/alleles"
		params.cgmlstLociBed = "${params.root}/assets/cgmlst/klebsiella_pneumoniae/bed"
		params.trainingFile = "${params.root}/assets/prodigal_training_files/Klebsiella_pneumoniae.trn"
	}
}

manifest {
	homePage = 'https://github.com/genomic-medicine-sweden/JASEN'
	description = 'Pipeline epitypes numerous bacterial species as well as identifies AMR and virulence genes'
	mainScript = 'main.nf'
	version = '1.0.0'
}
